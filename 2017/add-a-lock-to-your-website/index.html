<!DOCTYPE html><html lang=zh-cn><head><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><title>给你的网站加把锁 -- Let's Encrypt 完全体验 · 云淡风轻</title><meta name=description content="给你的网站加把锁 -- Let's Encrypt 完全体验 - 云淡风轻"><meta name=viewport content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1"><link rel="short icon" type=image/x-icon href=/images/favicon.ico><link rel=stylesheet href=/scss/apollo.css><link rel=stylesheet href=//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css><!--[if lt IE 9]><script src="/scripts/html5shiv/html5shiv.min.js"></script><script src="/scripts/html5shiv/html5shiv-printshiv.min.js"></script><![endif]--><link rel=search type=application/opensearchdescription+xml href=http://ioliu.cn/atom.xml title=云淡风轻></head><body><div class=wrap><header><a href="/" class=logo-link><img src=/images/favicon.png></a><ul class="nav nav-list"><li class=nav-list-item><a href="/" target=_self class=nav-list-link>Home</a></li><li class=nav-list-item><a href="/archives/" target=_self class=nav-list-link>Archive</a></li><li class=nav-list-item><a href="/tags/" target=_self class=nav-list-link>Tags</a></li><li class=nav-list-item><a href=http://weibo.com/1842336184 target=_blank class=nav-list-link>Weibo</a></li><li class=nav-list-item><a href=https://github.com/xcss target=_blank class=nav-list-link>GitHub</a></li><li class=nav-list-item><a href=/atom.xml target=_self class=nav-list-link>Rss</a></li></ul></header><section class=container><div class=post><article class=post-block><h1 class=post-title>给你的网站加把锁 -- Let's Encrypt 完全体验</h1><div class=post-info>2017年3月21日<a href="/tags/Let-s-Encrypt/" title="Let's Encrypt" class=post-tag>#Let's Encrypt</a><a href="/tags/https/" title=https class=post-tag>#https</a><a href="/tags/cerbot/" title=cerbot class=post-tag>#cerbot</a><span id="/2017/add-a-lock-to-your-website/" title="给你的网站加把锁 -- Let's Encrypt 完全体验" class=leancloud-visitors>-°</span><div class=cp-tip><div class=cp-scroll-x><p class=cp-post>本文作者:<a href=https:github.com/xcCss title=云淡风轻 target=_blank>云淡风轻</a></p><p class=cp-post-url>本文地址:<a href="http://ioliu.cn/2017/add-a-lock-to-your-website/" title="http://ioliu.cn/2017/add-a-lock-to-your-website/" target=_blank>http://ioliu.cn/2017/add-a-lock-to-your-website/</a></p><p class=cp-note>本文由 @云淡风轻 创作，转载请保留此声明。</p><p class=cp-note>所有权保留，请勿用作商业用途。</p></div></div></div><div class=post-content><p><img src=/images/placeholder.gif data-orig=https://ws1.sinaimg.cn/large/006qRazegy1fdunpet5toj30t50d7n3d.jpg alt=""></p><p>今天抽时间将所有的网站<a href=https://zh.wikipedia.org/wiki/%E5%82%B3%E8%BC%B8%E5%B1%A4%E5%AE%89%E5%85%A8%E5%8D%94%E8%AD%B0 target=_blank rel=external>SSL证书</a>都更新了成 <a href="https://letsencrypt.org/" target=_blank rel=external>Let’s Encrypt</a> 了。采用了<a href=https://certbot.eff.org target=_blank rel=external>certbot</a> 这样的自动化工具，配置管理起来非常容易(一本正经的胡说八道)，这里将对整个体验过程做个详细记录。</p><h1 id=了解-Let’s-Encrypt><a href=#了解-Let’s-Encrypt class=headerlink title="了解 Let’s Encrypt"></a>了解 Let’s Encrypt</h1><blockquote><p>The project aims to make encrypted connections in the World Wide Web the default case. By getting rid of payment, web server configuration, validation emails and dealing with expired certificates it is meant to significantly lower the complexity of setting up and maintaining TLS encryption.On a Linux web server, execution of only two commands is sufficient to set up HTTPS encryption, acquire and install certificates within 20 to 30 seconds.</p></blockquote><p><a href="https://letsencrypt.org/" target=_blank rel=external>Let’s Encrypt</a> 是一个将于2015年末推出的数字证书认证机构，将通过旨在消除当前手动创建和安装证书的复杂过程的自动化流程，为安全网站提供免费的SSL/TLS证书。<br><a id=more></a></p><h1 id=获取-Let’s-Encrypt><a href=#获取-Let’s-Encrypt class=headerlink title="获取 Let’s Encrypt"></a>获取 Let’s Encrypt</h1><p><img src=/images/placeholder.gif data-orig=https://ws1.sinaimg.cn/large/006qRazegy1fduo29ztewj30mb0bxt9d.jpg alt=""><br>Let’s Encrypt 证书生成不需要手动进行，官方推荐 <a href=https://certbot.eff.org target=_blank rel=external>Certbot</a> 这套自动化工具来实现。3步轻松搞定：</p><ul><li>下载安装 certbot (Let’s Encrypt项目的自动化工具)</li><li>获得SSL证书</li><li>修改Nginx配置文件</li><li>续订</li></ul><h2 id=1-安装-Certbot><a href=#1-安装-Certbot class=headerlink title="1. 安装 Certbot"></a>1. 安装 Certbot</h2><p>根据 <a href=https://certbot.eff.org target=_blank rel=external>Certbot</a> 官网指南，Debian 8上执行如下命令，安装certbot:<br><figure class="highlight bash"><table><tr><td class=code><pre><div class=line>$ sudo apt-get update</div><div class=line>$ sudo apt-get install certbot -t jessie-backports</div></pre></td></tr></table></figure></p><p>等安装完成，<code>certbot</code>就可以使用了。</p><h2 id=2-获取SSL证书><a href=#2-获取SSL证书 class=headerlink title="2. 获取SSL证书"></a>2. 获取SSL证书</h2><p>Let’s Encrypt提供了通过各种插件获取SSL证书的各种方法。不同的是Apache的插件，大多数的插件只会帮助你得到，你必须手动配置你的Web服务器使用证书。仅获取证书而不安装证书的插件称为“验证器”，因为它们用于验证服务器是否应颁发证书。<br>下面将使用<code>Webroot</code>的插件来获取SSL证书。</p><h4 id=如何使用-Webroot-插件：><a href=#如何使用-Webroot-插件： class=headerlink title="如何使用 Webroot 插件："></a>如何使用 Webroot 插件：</h4><p>Webroot 的工作插件放置在一个特殊的文件<code>/.well-known</code>目录文档根目录下，它可以打开（通过Web服务器）内由让我们的加密服务进行验证。 根据配置的不同，你可能需要明确允许访问/.well-known目录。</p><p>为了确保该目录可供Let’s Encrypt进行验证，让我们快速更改我们的Nginx配置。编辑<code>/etc/nginx/conf.d/example.com.conf</code>文件，并将下面代码添加进去:<br><figure class="highlight nginx"><table><tr><td class=code><pre><div class=line><span class=attribute>location</span> <span class=regexp>~ /.well-known</span> &#123;</div><div class=line>    <span class=attribute>allow</span> all;</div><div class=line>&#125;</div></pre></td></tr></table></figure></p><p>使用<code>nginx -t</code>测试配置文件是否正确，在正确的情况下，重新让Nginx重新加载配置文件:<br><figure class="highlight bash"><table><tr><td class=code><pre><div class=line>$ sudo systemctl reload nginx</div></pre></td></tr></table></figure></p><h4 id=使用certbot命令获取证书：><a href=#使用certbot命令获取证书： class=headerlink title=使用certbot命令获取证书：></a>使用certbot命令获取证书：</h4><figure class="highlight bash"><table><tr><td class=code><pre><div class=line>$ sudo certbot certonly --webroot -w /var/www/example <span class=_>-d</span> example.com <span class=_>-d</span> www.example.com -w /var/www/thing <span class=_>-d</span> thing.is <span class=_>-d</span> m.thing.is</div></pre></td></tr></table></figure><ul><li><code>-w</code>:指定网站所在目录</li><li><code>-d</code>:指定要生成证书的域名，如果你想多个域名保存在一个证书里(最多四个)(如<code>example.com</code>、<code>www.example.com</code>、<code>thing.is</code>、<code>m.thing.is</code>)，请确保使用适当的webroot路径和域名替换命令中的相对应部分。</li></ul><p>接下来，同意加密订阅协议：<br><img src=/images/placeholder.gif data-orig=https://ws1.sinaimg.cn/large/006qRazegy1fdup0jojf7j30fv0bdwf1.jpg alt=""></p><p>如果一切顺利，你应该看到一个类似下面的输出消息：</p><blockquote><p><strong>IMPORTANT NOTES:</strong></p><ul><li>Congratulations! Your certificate and chain have been saved at<br><code>/etc/letsencrypt/live/example.com/fullchain.pem</code>. Your cert will expire<br>on <strong><code>2017-06-19</code></strong>. To obtain a new or tweaked version of this<br>certificate in the future, simply run certbot again. To<br>non-interactively renew <em>all</em> of your certificates, run “certbot<br>renew”</li><li><p>If you like Certbot, please consider supporting our work by:</p><p>Donating to ISRG / Let’s Encrypt: <a href=https://letsencrypt.org/donate target=_blank rel=external>https://letsencrypt.org/donate</a><br>Donating to EFF: <a href=https://eff.org/donate-le target=_blank rel=external>https://eff.org/donate-le</a></p></li></ul></blockquote><h4 id=证书文件><a href=#证书文件 class=headerlink title=证书文件></a>证书文件</h4><p>如果运行顺利，所有服务器所需要的证书就已经生成好了。他们被放在了 <code>/etc/letsencrypt/live/example.com/</code> 下：<br><figure class="highlight bash"><table><tr><td class=code><pre><div class=line>$ ls /etc/letsencrypt/live/example.com/</div><div class=line>cert.pem <span class=comment>#server cert only  </span></div><div class=line>privkey.pem <span class=comment>#private key  </span></div><div class=line>chain.pem <span class=comment>#intermediates  </span></div><div class=line>fullchain.pem <span class=comment>#server cert + intermediates</span></div></pre></td></tr></table></figure></p><h3 id=3-修改Nginx配置文件><a href=#3-修改Nginx配置文件 class=headerlink title=3.修改Nginx配置文件></a>3.修改Nginx配置文件</h3><p>到这里已经成功一大半了，只需要配置 Nginx 支持刚刚生成的证书。最佳实践可以参考<a href="https://mozilla.github.io/server-side-tls/ssl-config-generator/" target=_blank rel=external>Mozilla SSL Configuration Generator</a>。<br><img src=/images/placeholder.gif data-orig=https://ws1.sinaimg.cn/large/006qRazegy1fdupi6lhxmj30oz0lon0q.jpg alt=""><br>注意去掉HSTS的勾(勾上会强制https，并且很难消除后续影响)。</p><p>请根据自己的服务配置修改和添加内容，<strong>重点只需要关注6行</strong>：<br><figure class=highlight><table><tr><td class=code><pre><div class=line>server &#123;  </div><div class=line>    listen 443 ssl http2;</div><div class=line>    ....</div><div class=line>    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;</div><div class=line>    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;</div><div class=line>    ssl_dhparam /etc/nginx/ssl/dhparam.pem;</div><div class=line></div><div class=line>    ssl_trusted_certificate /etc/letsencrypt/live/example.com/root_ca_cert_plus_intermediates;</div><div class=line></div><div class=line>    resolver &lt;IP DNS resolver&gt;;</div><div class=line>    ....</div><div class=line>&#125;</div></pre></td></tr></table></figure></p><p><code>dhparam.pem</code>可以通过以下命令生成：<br><figure class="highlight bash"><table><tr><td class=code><pre><div class=line>$ sudo mkdir /etc/nginx/ssl</div><div class=line>$ sudo openssl dhparam -out /etc/nginx/ssl/dhparam.pem 2048</div></pre></td></tr></table></figure></p><p>Nginx 配置完成后重启，用浏览器测试是否一切正常。<br><img src=/images/placeholder.gif data-orig=https://ws1.sinaimg.cn/large/006qRazegy1fdupmoluqij306y035glg.jpg alt=""></p><h3 id=4-续订><a href=#4-续订 class=headerlink title=4.续订></a>4.续订</h3><p><code>Let&#39;s Encrypt</code>证书有效期只有3个月，所以，需要定时renew。我将使用<code>corntab</code>来执行renew命令:<br><figure class="highlight bash"><table><tr><td class=code><pre><div class=line>$ sudo crontab <span class=_>-e</span></div></pre></td></tr></table></figure></p><p>添加以下行：<br><figure class="highlight plain"><table><tr><td class=code><pre><div class=line>30 2 * * 1 /usr/bin/certbot renew &gt;&gt; /var/log/le-renew.log &amp;&amp; /bin/systemctl reload nginx</div></pre></td></tr></table></figure></p><p>保存，并退出。这个定时任务将在每个星期一的凌晨两点半执行<code>certbot renew</code>命令，并重启Nginx。最后将日志输出到<code>/var/log/le-renewal.log</code>。</p><h1 id=测试你的网站-SSL-安全性><a href=#测试你的网站-SSL-安全性 class=headerlink title="测试你的网站 SSL 安全性"></a>测试你的网站 SSL 安全性</h1><p><a href=https://www.ssllabs.com/ssltest/index.html target=_blank rel=external>Qualys SSL Labs</a> 提供了全面的 SSL 安全性测试，填写你的网站域名，给自己的 HTTPS 配置打个分。<br><img src=/images/placeholder.gif data-orig=https://ws1.sinaimg.cn/large/006qRazegy1fdupydm71rj30ts0fkt9s.jpg alt=""><br>这意味着你网站的HTTPS已经启用成功啦，为自己鼓个掌。 (๑•̀ㅂ•́)و✧。</p></div></article></div></section><footer><div class=paginator><a href="/2016/hello-november/" class=next>下一篇</a></div><div data-thread-key="2017/add-a-lock-to-your-website/" data-title="给你的网站加把锁 -- Let's Encrypt 完全体验" data-url="http://ioliu.cn/2017/add-a-lock-to-your-website/" data-author-key=1 class=ds-thread></div><script>var duoshuoQuery={short_name:"ioliu"};!function(){var t=document.createElement("script");t.id="duoshuo-script",t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https:":"http:")+"//dn-ds-img.qbox.me/embed.js",t.charset="UTF-8",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)}();</script><script>window.CONFIG={duoshuo:{userId:"ioliu",anthor:"云淡风轻"}};</script><div class=copyright><p>© 2013 - 2017 <a href=http://ioliu.cn>云淡风轻</a>, <a href="http://www.miitbeian.gov.cn/" rel=nofollow target=_blank>粤ICP备15050037号</a> .</p><p>Powered By <a href="https://hexo.io/" rel=nofollow target=_blank>Hexo</a> and <a href=https://github.com/pinggod/hexo-theme-apollo rel=nofollow target=_blank>hexo-theme-apollo</a></p></div></footer></div><script src="/scripts/ua-parser.min.js?v=0.7.9"></script><script src=/scripts/hook-duoshuo.js></script><script src=/scripts/visibility.js></script><script src=/scripts/lazy.js></script><script>echo.lazyAttr="data-orig";</script><script>echo.init({offsetBottom:400,throttle:200,unload:!0,callback:function(t,e){}}),document.addEventListener("DOMContentLoaded",function(){echo.render()},!1);</script><script>/^http:\/\/localhost/.test(location.href)||/_@_@_@=#\$#\$#\$/.test(document.cookie)||(!function(e,t,a,o,n,c){e.GoogleAnalyticsObject=o,e[o]||(e[o]=function(){(e[o].q=e[o].q||[]).push(arguments)}),e[o].l=+new Date,n=t.createElement(a),c=t.getElementsByTagName(a)[0],n.src="https://www.google-analytics.com/analytics.js",c.parentNode.insertBefore(n,c)}(window,document,"script","ga"),ga("create","UA-61934506-1","auto"),ga("send","pageview"));</script><script>if(!/^http:\/\/localhost/.test(location.href)){var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?2119376191e432c012a0713bcca8a8ea";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()}</script><script src=https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js></script><script src=/scripts/lean-analytics.js></script><script>AV.initialize("R9cQjqaD9AXPKY7AQiU6U6yl","YHUU5n9sbvpRQCdiIU8aRsmH");</script></body></html>